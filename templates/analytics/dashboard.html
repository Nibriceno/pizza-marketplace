<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š Dashboard de Actividad</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'analytics/css/dashboard.css' %}">
</head>
<body>
  <h1>ğŸ“Š Dashboard de Actividad de Usuarios</h1>

  <!-- Contadores -->
  <div class="stats">
    <div class="card">
      <h3>Total acciones</h3>
      <p class="stat-value">{{ total }}</p>
    </div>
    <div class="card">
      <h3>Total errores</h3>
      <p class="stat-value error">{{ errores }}</p>
    </div>
    <div class="card">
      <h3>Usuarios Ãºnicos</h3>
      <p class="stat-value">{{ usuarios }}</p>
    </div>
  </div>

  <!-- Acciones mÃ¡s comunes -->
  <div class="card top-actions">
    <h3>Acciones mÃ¡s comunes</h3>
    <ul>
      {% for a in mas_comunes %}
        <li>{{ a.action }} â€” <strong>{{ a.total }}</strong> veces</li>
      {% empty %}
        <li>No hay registros suficientes aÃºn.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Filtros -->
  <form method="get" class="filters">
    <label>Tipo:</label>
    <select name="tipo">
      <option value="" {% if not tipo %}selected{% endif %}>Todos</option>
      <option value="error" {% if tipo == 'error' %}selected{% endif %}>Solo errores</option>
      <option value="global" {% if tipo == 'global' %}selected{% endif %}>Errores globales</option>
      <option value="accion" {% if tipo == 'accion' %}selected{% endif %}>Solo acciones</option>
    </select>

    <label>Usuario:</label>
    <input type="text" name="usuario" value="{{ usuario_filtro }}" placeholder="nombre de usuario">

    <label>Origen:</label>
    <select name="page">
      <option value="">Todos</option>
      <option value="manychat" {% if page == 'manychat' %}selected{% endif %}>ğŸ¤– Bot ManyChat</option>
      <option value="web" {% if page == 'web' %}selected{% endif %}>ğŸŒ Web</option>
    </select>

    <label>SecciÃ³n:</label>
    <select name="section">
      <option value="">Todas</option>
      <option value="productos" {% if section == 'productos' %}selected{% endif %}>ğŸ• Productos</option>
      <option value="categorias" {% if section == 'categorias' %}selected{% endif %}>ğŸ“‚ CategorÃ­as</option>
      <option value="carrito" {% if section == 'carrito' %}selected{% endif %}>ğŸ›’ Carrito</option>
      <option value="checkout" {% if section == 'checkout' %}selected{% endif %}>ğŸ’³ Checkout</option>
      <option value="errores" {% if section == 'errores' %}selected{% endif %}>âŒ Errores</option>
      <option value="bot" {% if section == 'bot' %}selected{% endif %}>ğŸ¤– Bot</option>
      <option value="otros" {% if section == 'otros' %}selected{% endif %}>ğŸ“„ Otros</option>
    </select>

    <label>Fecha:</label>
    <select name="fecha">
      <option value="" {% if not fecha %}selected{% endif %}>Todas</option>
      <option value="hoy" {% if fecha == 'hoy' %}selected{% endif %}>Hoy</option>
    </select>

    <button type="submit">Filtrar</button>
  </form>

  <!-- Tabla -->
  <table>
    <thead>
      <tr>
        <th>Fecha y hora</th>
        <th>Usuario</th>
        <th>AcciÃ³n</th>
        <th>Origen</th>
        <th>SecciÃ³n</th>
        <th>ID Producto</th>
        <th>Detalles</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
        <tr class="
          {% if log.row_class == 'row-bot' %}row-bot
          {% elif log.row_class == 'row-error' %}row-error
          {% else %}row-web{% endif %}
        ">
          <td>{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
          <td>
            {% if log.user %}
              {{ log.user.username }}
            {% elif log.user_name %}
              {{ log.user_name }}
            {% else %}
              AnÃ³nimo
            {% endif %}
          </td>
          <td>{{ log.action }}</td>
          <td>{{ log.page|default:"-" }}</td>
          <td>
            {% if log.section %}
              <span class="tag tag-{{ log.section|lower }}">{{ log.section }}</span>
            {% else %}
              <span class="tag tag-default">-</span>
            {% endif %}
          </td>
          <td>{{ log.product_id|default:"-" }}</td>
          <td>
            {% if log.extra_data %}
              <div class="json-box">{{ log.extra_data|safe }}</div>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7" style="text-align:center;">No hay registros que coincidan con los filtros.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

</body>
</html>

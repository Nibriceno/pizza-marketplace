<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Actividad</title>
  <style>
    body { font-family: sans-serif; background: #f9fafb; color: #222; padding: 2rem; }
    h1 { color: #0d9488; }
    .stats { display: flex; gap: 2rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .card { background: white; padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); min-width: 200px; }
    table { border-collapse: collapse; width: 100%; background: white; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #0d9488; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr.error-row { background: #fee2e2 !important; } /* filas de error en rojo claro */
    .filters { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    label { font-weight: bold; }
    select, input { margin-right: 10px; padding: 5px; }
    button { background: #0d9488; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0b7669; }
    .json-box { font-family: monospace; background: #f3f4f6; border-radius: 6px; padding: 6px 8px; font-size: 0.85rem; overflow-x: auto; }
    .json-key { color: #7c3aed; }
    .json-value { color: #059669; }
    .json-string { color: #2563eb; }
  </style>
</head>
<body>

  <h1>üìä Dashboard de Actividad de Usuarios</h1>

  <!-- Contadores -->
  <div class="stats">
    <div class="card">
      <h3>Total acciones</h3>
      <p style="font-size:1.4rem; font-weight:bold;">{{ total }}</p>
    </div>
    <div class="card">
      <h3>Total errores</h3>
      <p style="font-size:1.4rem; font-weight:bold; color:#dc2626;">{{ errores }}</p>
    </div>
    <div class="card">
      <h3>Usuarios √∫nicos</h3>
      <p style="font-size:1.4rem; font-weight:bold;">{{ usuarios }}</p>
    </div>
  </div>

  <!-- Top acciones
  <div class="card" style="margin-bottom: 1.5rem;">
    <h3>üî• Acciones m√°s comunes</h3>
    <ul>
      {% for a in mas_comunes %}
        <li>{{ a.action }} ‚Äî <strong>{{ a.total }}</strong> veces</li>
      {% empty %}
        <li>No hay registros suficientes a√∫n.</li>
      {% endfor %}
    </ul>
  </div> -->

  <!-- Filtros -->
  <form method="get" class="filters">
    <label>Tipo:</label>
    <select name="tipo">
      <option value="" {% if not tipo %}selected{% endif %}>Todos</option>
      <option value="error" {% if tipo == 'error' %}selected{% endif %}>Solo errores</option>
      <option value="global" {% if tipo == 'global' %}selected{% endif %}>Solo errores globales</option>
      <option value="accion" {% if tipo == 'accion' %}selected{% endif %}>Solo acciones</option>
    </select>

    <label>Usuario:</label>
    <input type="text" name="usuario" value="{{ usuario_filtro }}" placeholder="nombre de usuario">

    <label>Secci√≥n:</label>
    <select name="page">
      <option value="">Todas</option>
      <option value="cart" {% if 'cart' in page|default:'' %}selected{% endif %}>üõí Carrito / Pagos</option>
      <option value="product" {% if 'product' in page|default:'' %}selected{% endif %}>üçï Productos</option>
      <option value="analytics" {% if 'analytics' in page|default:'' %}selected{% endif %}>üìä Analytics</option>
      <option value="manychat" {% if 'manychat' in page|default:'' %}selected{% endif %}>ü§ñ Bot ManyChat</option>
    </select>

    <label>Fecha:</label>
    <select name="fecha">
      <option value="" {% if not fecha %}selected{% endif %}>Todas</option>
      <option value="hoy" {% if fecha == 'hoy' %}selected{% endif %}>Hoy</option>
    </select>

    <button type="submit">Filtrar</button>
  </form>

  <!-- Tabla de logs -->
  <table>
    <thead>
      <tr>
        <th>Fecha y hora</th>
        <th>Usuario</th>
        <th>Acci√≥n</th>
        <th>P√°gina</th>
        <th>ID Producto</th>
        <th>Tel√©fono</th>
        <th>Detalles</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr class="{% if 'ERROR' in log.action %}error-row{% endif %}">
        <td>{{ log.created_at|date:"Y-m-d H:i:s" }}</td>
        <td>
          {% if log.user %}
            {{ log.user.username }}
          {% elif log.user_name %}
            {{ log.user_name }}
          {% else %}
            An√≥nimo
          {% endif %}
        </td>
        <td>{{ log.action }}</td>
        <td>{{ log.page|default:"-" }}</td>
        <td>{{ log.product_id|default:"-" }}</td>
        <td>
          {% if log.user and log.user.profile.phone %}
            {{ log.user.profile.phone }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if log.extra_data %}
            <div class="json-box">
              {{ log.extra_data|safe }}
            </div>
          {% elif log.message %}
            <div class="json-box">
              {{ log.message }}
            </div>
          {% else %}
            -
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" style="text-align:center;">No hay registros que coincidan con los filtros.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</body>
</html>

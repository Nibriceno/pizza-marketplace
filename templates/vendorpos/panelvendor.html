{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel del Vendedor â€“ POS</title>

    <!-- Bulma -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">

    <style>
        body {
            background: #f5f5f5;
        }
        .sidebar {
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }
        .order-item:hover {
            background: #f0f0f0;
            cursor: pointer;
        }
    </style>
</head>

<body>

<div class="columns m-0">

    <!-- SIDEBAR IZQUIERDA -->
    <div class="column is-3 sidebar p-4">

        <h1 class="title is-4">ðŸ§¾ Ã“rdenes</h1>

        <div class="menu">

            <ul class="menu-list">
                {% for order in orders %}
                <li>
                    <a href="?order={{ order.id }}" class="order-item box mb-3">

                        <div class="is-flex is-justify-content-space-between">
                            <span class="has-text-weight-semibold">#{{ order.id }}</span>
                            <small class="has-text-grey">
                                {{ order.created_at|date:'d/m H:i' }}
                            </small>
                        </div>

                        <p class="mt-1">Total: ${{ order.paid_amount }}</p>

                        {% if order.status == 'pending' %}
                            <span class="tag is-warning is-light mt-2">Pendiente</span>
                        {% elif order.status == 'accepted' %}
                            <span class="tag is-info is-light mt-2">Aceptada</span>
                        {% elif order.status == 'preparing' %}
                            <span class="tag is-link is-light mt-2">Preparando</span>
                        {% elif order.status == 'ready' %}
                            <span class="tag is-success is-light mt-2">Lista</span>
                        {% elif order.status == 'delivered' %}
                            <span class="tag is-dark is-light mt-2">Entregada</span>
                        {% elif order.status == 'rejected' %}
                            <span class="tag is-danger is-light mt-2">Rechazada</span>
                        {% endif %}
                    </a>
                </li>
                {% endfor %}
            </ul>

        </div>

    </div>


    <!-- PANEL DERECHO -->
    <div class="column is-9 p-6">

        {% if selected_order %}

        <div class="box">

            <h2 class="title is-3">Orden #{{ selected_order.id }}</h2>

            <div class="columns">
                <div class="column is-6">
                    <p><strong>Cliente:</strong> {{ selected_order.first_name }} {{ selected_order.last_name }}</p>
                    <p><strong>DirecciÃ³n:</strong> {{ selected_order.address }}</p>
                    <p><strong>TelÃ©fono:</strong> {{ selected_order.phone }}</p>
                </div>

                <div class="column is-6">
                    <p>
                        <strong>Total:</strong>
                        <span class="has-text-success has-text-weight-bold">
                            ${{ selected_order.paid_amount }}
                        </span>
                    </p>

                    <p class="mt-2">
                        <strong>Estado actual:</strong><br>

                        {% if selected_order.status == 'pending' %}
                            <span class="tag is-warning is-light is-medium">Pendiente</span>
                        {% elif selected_order.status == 'accepted' %}
                            <span class="tag is-info is-light is-medium">Aceptada</span>
                        {% elif selected_order.status == 'preparing' %}
                            <span class="tag is-link is-light is-medium">Preparando</span>
                        {% elif selected_order.status == 'ready' %}
                            <span class="tag is-success is-light is-medium">Lista</span>
                        {% elif selected_order.status == 'delivered' %}
                            <span class="tag is-dark is-light is-medium">Entregada</span>
                        {% elif selected_order.status == 'rejected' %}
                            <span class="tag is-danger is-light is-medium">Rechazada</span>
                        {% endif %}
                    </p>
                </div>
            </div>


            <h3 class="title is-5 mt-5">Items</h3>
            <table class="table is-fullwidth is-striped">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio unidad</th>
                  </tr>
                </thead>
                <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.product.title }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>${{ item.price }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>


            <!-- CAMBIAR ESTADO -->
            <div class="mt-6">
                <h3 class="title is-5">Cambiar estado</h3>

                <form id="statusForm">
                    {% csrf_token %}
                    <div class="field is-grouped">
                        <div class="control">
                            <div class="select is-medium">
                                <select name="status" id="status">
                                    <option value="accepted">Aceptar</option>
                                    <option value="rejected">Rechazar</option>
                                    <option value="preparing">Preparando</option>
                                    <option value="ready">Listo para retiro</option>
                                    <option value="delivered">Entregado</option>
                                </select>
                            </div>
                        </div>

                        <div class="control">
                            <button class="button is-primary is-medium">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>

        </div>


        <script>
            document.getElementById("statusForm").onsubmit = function(e) {
                e.preventDefault();

                fetch("/vendorpos/order/{{ selected_order.id }}/status/", {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: new FormData(this)
                })
                .then(r => r.json())
                .then(data => {
                    alert("Estado actualizado a: " + data.new_status);
                    location.reload();
                });
            };
        </script>


        {% else %}

        <div class="has-text-centered mt-6">
            <p class="title is-4 has-text-grey">Selecciona una orden en la izquierda</p>
        </div>

        {% endif %}

    </div>
</div>

</body>
</html>

{% extends 'core/base.html' %}

{% block title %}Mi Perfil{% endblock %}

{% block content %}
<h1 class="title">Mi Perfil ğŸ‘¤</h1>

<div class="box">

    <!-- DATOS BÃSICOS -->
    <p><strong>Usuario:</strong> {{ username }}</p>
    <p><strong>Email:</strong> {{ email }}</p>
    <p><strong>PaÃ­s:</strong> {{ profile.country }}</p>
    <p><strong>Comuna:</strong> {{ profile.comuna }}</p>

    <hr>

    <!-- ğŸ¥¦ PREFERENCIAS -->
    <h2 class="subtitle mb-2">Preferencias Alimentarias ğŸ½ï¸</h2>

    {% if profile.preferences.count > 0 %}
        <div class="tags mb-3">
            {% for pref in profile.preferences.all %}
                <span class="tag is-success is-light" style="font-size: .95rem; padding: .6rem 1rem; border-radius: 12px; display:inline-flex; align-items:center; gap:.4rem;">
                    {% if pref.name|lower == "vegana" %}
                        ğŸŒ±
                    {% elif pref.name|lower == "sin gluten" %}
                        ğŸŒ¾
                    {% else %}
                        ğŸ•
                    {% endif %}
                    {{ pref.name }}
                </span>
            {% endfor %}
        </div>
    {% else %}
        <p class="has-text-grey mb-3">No has seleccionado preferencias aÃºn.</p>
    {% endif %}

    <hr>

    <!-- ğŸ”§ FORMULARIO INLINE PARA EDITAR PREFERENCIAS -->
    <h2 class="subtitle mt-4">Editar Preferencias</h2>

    <form method="POST" id="prefForm">
        {% csrf_token %}

        <style>
            .pref-grid {
                display: flex; flex-wrap: wrap; gap: .8rem;
            }
            .pref-chip {
                position: relative;
                padding: .7rem 1.2rem .7rem 2.2rem;
                border-radius: 9999px;
                cursor: pointer;
                font-size: 1rem;
                background: #eef2f7;
                color: #111;
                border: 2px solid transparent;
                transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
                user-select: none;
                outline: none;
            }
            .pref-chip[data-selected="true"] {
                background: #0d9488;
                color: #fff;
                border-color: #0b7669;
                transform: translateY(-1px) scale(1.02);
                box-shadow: 0 6px 12px rgba(0,0,0,.12);
            }
            .pref-chip .check {
                position: absolute; left: .6rem; top: 50%; transform: translateY(-50%);
                width: 1.2rem; height: 1.2rem; border-radius: 9999px;
                display: grid; place-items: center;
                background: #cbd5e1; color: #111; font-size: .85rem;
                transition: background .12s ease, color .12s ease;
            }
            .pref-chip[data-selected="true"] .check { background: #0b7669; color: #fff; }
            .pref-hidden { display: none; }
        </style>

            <div class="pref-grid">

            {% for pref in preferences %}
                
                <label
                    class="pref-chip {% if pref.id in selected_ids %}selected{% endif %}"
                    tabindex="0"
                    data-selected="{% if pref.id in selected_ids %}true{% else %}false{% endif %}"
                    aria-pressed="{% if pref.id in selected_ids %}true{% else %}false{% endif %}"
                >
                    <span class="check">âœ“</span>

                    {% if pref.name|lower == "vegana" %}
                        ğŸŒ± {{ pref.name }}
                    {% elif pref.name|lower == "sin gluten" %}
                        ğŸŒ¾ {{ pref.name }}
                    {% else %}
                        ğŸ• {{ pref.name }}
                    {% endif %}

                    <input type="checkbox" class="pref-hidden" name="preferences" value="{{ pref.id }}"
                    {% if pref.id in selected_ids %}checked{% endif %}>
                </label>

            {% endfor %}
        </div>


        <div class="is-flex is-justify-content-flex-end mt-4" style="gap:.5rem;">
            <button type="reset" id="prefReset" class="button is-light">Restablecer</button>
            <button type="submit" id="prefSave" class="button is-link" disabled>Guardar Cambios</button>
        </div>

        <p id="prefHint" class="has-text-grey is-size-7 mt-2" style="display:none;">
            Tienes cambios sin guardar.
        </p>

    </form>

</div>

<!-- SCRIPT INTERACTIVO -->
<script>
(function () {
  const chips = [...document.querySelectorAll('.pref-chip')];
  const saveBtn = document.getElementById('prefSave');
  const resetBtn = document.getElementById('prefReset');
  const hint = document.getElementById('prefHint');

  const initial = new Map();
  chips.forEach(chip => {
    const input = chip.querySelector('input.pref-hidden');
    initial.set(input.value, input.checked);
  });

  const setDirty = (dirty) => {
    saveBtn.disabled = !dirty;
    hint.style.display = dirty ? 'block' : 'none';
  };

  const isDirty = () => chips.some(chip => {
    const input = chip.querySelector('input.pref-hidden');
    return initial.get(input.value) !== input.checked;
  });

  chips.forEach(chip => {
    chip.addEventListener('click', () => toggleChip(chip));
    chip.addEventListener('keydown', (e) => {
      if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
        toggleChip(chip);
      }
    });
  });

  function toggleChip(chip) {
    const input = chip.querySelector('input.pref-hidden');
    input.checked = !input.checked;
    chip.dataset.selected = String(input.checked);
    chip.setAttribute('aria-pressed', String(input.checked));
    setDirty(isDirty());
  }

  resetBtn.addEventListener('click', () => {
    chips.forEach(chip => {
      const input = chip.querySelector('input.pref-hidden');
      const start = initial.get(input.value);
      input.checked = start;
      chip.dataset.selected = String(start);
      chip.setAttribute('aria-pressed', String(start));
    });
    setDirty(false);
  });

  setDirty(false);
})();
</script>

{% endblock %}

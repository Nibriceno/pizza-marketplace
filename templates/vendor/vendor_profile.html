{% extends 'core/base.html' %}

{% block title %}Panel del Vendedor{% endblock %}

{% block content %}

<h1 class="title has-text-centered">
    üçï Panel del Vendedor ‚Äì <span class="is-capitalized">{{ vendor.name }}</span>
</h1>

<!-- SALDOS -->
<div class="box has-background-light">
    <div class="columns is-multiline has-text-centered">
        <div class="column is-6">
            <p class="is-size-4"><strong>üíµ Mi Saldo</strong></p>
            <p class="is-size-3 has-text-success">${{ vendor.get_balance }}</p>
        </div>
        <div class="column is-6">
            <p class="is-size-4"><strong>üì¨ Pagado</strong></p>
            <p class="is-size-3 has-text-info">${{ vendor.get_paid_amount }}</p>
        </div>
    </div>
</div>

<!-- MEN√ö SEMANAL / HIST√ìRICO -->
<div class="box">
    <div class="level is-mobile">
        <div class="level-left">
            <p class="title is-5 mb-0">üçΩÔ∏è Men√∫ destacado del vendedor</p>
        </div>
        <div class="level-right">
            <div class="buttons">
                <a href="{% url 'vendor:weekly_menu_edit' %}"
                   class="button is-primary is-light">
                    üìÜ Configurar men√∫ pr√≥ximos 7 d√≠as
                </a>
                <a href="{% url 'vendor:weekly_menu_history' %}"
                   class="button is-link is-light">
                    üìö Ver hist√≥rico de men√∫
                </a>
            </div>
        </div>
    </div>
</div>

<!-- MIS PRODUCTOS -->
<div class="box">
    <div class="level">
        <h2 class="title is-4">üõí Mis Productos</h2>
        <a href="{% url 'vendor:add-product' %}" class="button is-primary">‚ûï Agregar Producto</a>
    </div>

    {% if products %}
        <table class="table is-fullwidth is-striped is-hoverable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>T√≠tulo</th>
                    <th>Precio</th>
                    <th>Oferta</th>
                    <th style="width: 160px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>{{ forloop.counter }}</td>

                    <td>
                        <a href="{% url 'product:product' product.category.slug product.slug %}">
                            {{ product.title }}
                        </a>
                    </td>

                    <!-- PRECIO NORMAL + PRECIO FINAL -->
                    <td>
                        {% if product.get_final_price != product.price %}
                            <span style="text-decoration: line-through; color:#888;">
                                ${{ product.price }}
                            </span><br>
                            <span class="has-text-danger has-text-weight-bold">
                                ${{ product.get_final_price }}
                            </span>
                        {% else %}
                            ${{ product.price }}
                        {% endif %}
                    </td>

                    <!-- BADGE DE OFERTA -->
                    <td>
                        {% if product.active_offer %}
                            <span class="tag is-success is-light">üî• Oferta activa</span>
                        {% else %}
                            <span class="tag is-light">Sin oferta</span>
                        {% endif %}
                    </td>

                    <!-- ACCIONES -->
                    <td class="is-flex is-flex-direction-column is-align-items-flex-start" style="gap: 6px;">
                        <a href="{% url 'vendor:edit-offer' product.id %}"
                           class="button is-info is-small">
                           Editar Oferta
                        </a>

                        <a href="{% url 'vendor:delete-product' product.pk %}"
                           class="button is-danger is-small"
                           onclick="return confirm('¬øEliminar este producto?');">
                           Eliminar
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="has-text-grey">A√∫n no has agregado productos.</p>
    {% endif %}
</div>

<!-- ========================================================= -->
<!-- üöÄ DASHBOARD DE VENTAS DEL VENDEDOR + FILTROS            -->
<!-- ========================================================= -->

<div class="box">
    <h2 class="title is-3 has-text-centered">üìä Mis Estad√≠sticas de Venta</h2>

    <!-- FILTROS -->
    <div class="buttons has-addons is-centered" style="margin-bottom: 20px;">
        <button class="button is-link" onclick="loadDashboard('today')">Hoy</button>
        <button class="button is-info" onclick="loadDashboard('7days')">√öltimos 7 d√≠as</button>
        <button class="button is-primary" onclick="loadDashboard('30days')">√öltimos 30 d√≠as</button>
    </div>

    <!-- Ventas por d√≠a -->
    <div class="box">
        <h3 class="title is-4">üìÖ Ventas por d√≠a</h3>
        <canvas id="salesChart" style="max-height: 260px;"></canvas>
    </div>

    <!-- Top productos -->
    <div class="box" id="top-products-box">
        <h3 class="title is-4">üî• Pizzas m√°s vendidas</h3>
        <canvas id="topProductsChart" style="max-height: 260px;"></canvas>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let salesChartInstance = null;
let topProductsChartInstance = null;

// ==================================================
// üî• CARGAR AMBOS GR√ÅFICOS
// ==================================================
function loadDashboard(range) {
    loadSalesData(range);
    loadTopProducts(range);
}

// ==================================================
// üìå 1) GR√ÅFICO: VENTAS POR D√çA
// ==================================================
function loadSalesData(range) {
    fetch(`/analytics/vendor/sales-data/?range=${range}`)
        .then(r => r.json())
        .then(data => renderSalesChart(data));
}

function renderSalesChart(data) {
    const ctx = document.getElementById("salesChart").getContext("2d");

    if (salesChartInstance) salesChartInstance.destroy();

    salesChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: data.map(d => d.day),
            datasets: [{
                label: "Ventas por d√≠a",
                data: data.map(d => d.total),
                backgroundColor: "rgba(54, 162, 235, 0.6)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// ==================================================
// üî• 2) GR√ÅFICO: TOP PRODUCTOS (HORIZONTAL)
// ==================================================
function loadTopProducts(range) {
    fetch(`/analytics/vendor/top-products/?range=${range}`)
        .then(r => r.json())
        .then(data => renderTopProductsChart(data));
}

function renderTopProductsChart(data) {
    // üî• RECREAR CANVAS
    const box = document.getElementById("top-products-box");
    const oldCanvas = document.getElementById("topProductsChart");
    oldCanvas.remove();

    const canvas = document.createElement("canvas");
    canvas.id = "topProductsChart";
    canvas.style.maxHeight = "260px";
    box.appendChild(canvas);

    const ctx = canvas.getContext("2d");

    topProductsChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: data.map(d => d.product),
            datasets: [{
                label: "Unidades vendidas",
                data: data.map(d => d.total),
                backgroundColor: "rgba(255, 159, 64, 0.6)",
                borderColor: "rgba(255, 159, 64, 1)",
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            indexAxis: "y",
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

// ==================================================
// ‚úî Cargar por defecto
// ==================================================
document.addEventListener("DOMContentLoaded", () => loadDashboard("7days"));
</script>

{% endblock %}

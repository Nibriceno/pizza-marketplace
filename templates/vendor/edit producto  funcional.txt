{% extends 'core/base.html' %}
{% load widget_tweaks %}

{% block title %}Editar Oferta â€“ {{ product.title }}{% endblock %}

{% block content %}

{% now "U" as now_ts %}
{% with tomorrow_ts=now_ts|add:"86400" %}
{% with tomorrow=tomorrow_ts|date:"Y-m-d\\TH:i" %}

<div class="container mt-6">
    <div class="column is-half is-offset-one-quarter">
        <div class="box">

            <h1 class="title has-text-centered mb-5">
                ðŸ”¥ Oferta para <span class="has-text-info">{{ product.title }}</span>
            </h1>

            <!-- INFO DEL PRODUCTO -->
            <div class="notification is-light">
                <strong>Precio normal:</strong> ${{ product.price }} <br>

                {% if product.active_offer %}
                    <strong>Precio actual con oferta:</strong> 
                    ${{ product.final_price }}
                    <span class="tag is-success is-light">Oferta activa</span>
                {% else %}
                    <span class="tag is-light">Sin oferta activa</span>
                {% endif %}
            </div>

            <form method="post">
                {% csrf_token %}

                <!-- CAMPOS DEL FORM -->
                {% for field in form %}
                <div class="field mt-4">
                    <label class="label">{{ field.label }}</label>
                    <div class="control">

                        {% if field.field.widget.input_type == "datetime-local" %}
                            {{ field|add_class:"input" }}

                            <!-- Aplicar MIN dinÃ¡mico -->
                            <script>
                                document.addEventListener("DOMContentLoaded", function() {
                                    const input = document.getElementById("id_{{ field.name }}");
                                    if (input) {
                                        input.setAttribute("min", "{{ tomorrow }}");
                                    }
                                });
                            </script>

                        {% elif field.name == "is_2x1" %}
                            <label class="checkbox">
                                {{ field }} 2x1
                            </label>

                        {% elif field.name == "is_active" %}
                            <label class="checkbox">
                                {{ field }} Activar oferta
                            </label>

                        {% else %}
                            {{ field|add_class:"input" }}
                        {% endif %}

                    </div>

                    {% if field.errors %}
                        <p class="help is-danger">{{ field.errors }}</p>
                    {% endif %}
                </div>
                {% endfor %}

                
                <!-- PREVIEW DEL PRECIO FINAL -->
                <div class="box mt-5 has-background-info-light">
                    <h2 class="subtitle mb-2">ðŸ’° Vista previa del precio final</h2>
                    <p><strong>Precio normal:</strong> ${{ product.price }}</p>
                    <p><strong>Precio final estimado:</strong> 
                        <span id="preview-final" class="has-text-weight-bold">$â€”</span>
                    </p>
                </div>


                <!-- BOTONES -->
                <div class="field mt-6">
                    <button class="button is-primary is-medium is-fullwidth">
                        Guardar oferta
                    </button>
                </div>

                <a href="{% url 'vendor:vendor-admin' %}" 
                   class="button is-light is-fullwidth mt-2">
                    Volver
                </a>

            </form>

        </div>
    </div>
</div>


<!-- JS DESCUENTOS + 2X1 -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const discountPercentage = document.getElementById("id_discount_percentage");
    const discountPrice = document.getElementById("id_discount_price");
    const is2x1 = document.getElementById("id_is_2x1");
    const preview = document.getElementById("preview-final");
    const price = JSON.parse('{{ product.price|safe }}');

    function updatePreview() {
        let final = price;

        if (discountPrice && discountPrice.value.trim() !== "") {
            final = parseInt(discountPrice.value);
        } 
        else if (discountPercentage && discountPercentage.value.trim() !== "") {
            final = price - Math.round(price * (discountPercentage.value / 100));
        }

        if (!isNaN(final)) {
            preview.textContent = "$" + final.toLocaleString();
        } else {
            preview.textContent = "$â€”";
        }
    }


    // ðŸ”¥ REGLA: si activa 2x1 â†’ bloquear descuentos
    if (is2x1) {
        is2x1.addEventListener("change", () => {
            if (is2x1.checked) {
                if (discountPercentage) discountPercentage.value = "";
                if (discountPrice) discountPrice.value = "";

                if (discountPercentage) discountPercentage.setAttribute("disabled", "disabled");
                if (discountPrice) discountPrice.setAttribute("disabled", "disabled");
            } else {
                if (discountPercentage) discountPercentage.removeAttribute("disabled");
                if (discountPrice) discountPrice.removeAttribute("disabled");
            }
            updatePreview();
        });
    }

    // ðŸ”¥ REGLA: si escribe % descuento â†’ bloquear 2x1 + precio rebajado
    if (discountPercentage) {
        discountPercentage.addEventListener("input", () => {
            if (discountPercentage.value.trim() !== "") {
                if (is2x1) is2x1.checked = false;
                if (discountPrice) discountPrice.value = "";

                if (discountPrice) discountPrice.removeAttribute("disabled");
            }
            updatePreview();
        });
    }

    // ðŸ”¥ REGLA: si escribe precio rebajado â†’ bloquear % + 2x1
    if (discountPrice) {
        discountPrice.addEventListener("input", () => {
            if (discountPrice.value.trim() !== "") {
                if (is2x1) is2x1.checked = false;
                if (discountPercentage) discountPercentage.value = "";

                if (discountPercentage) discountPercentage.removeAttribute("disabled");
            }
            updatePreview();
        });
    }

    updatePreview();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const startInput = document.getElementById("id_start_date");
    const endInput = document.getElementById("id_end_date");

    if (!startInput || !endInput) return;

    function updateEndDateMin() {
        if (!startInput.value) return;

        // Convertir el valor del input a fecha real
        const startDate = new Date(startInput.value);

        // Crear fecha mÃ­nima (start_date + 1 minuto)
        const minEnd = new Date(startDate.getTime() + 1 * 60000);

        // Convertir a formato ISO compatible con datetime-local
        const iso = minEnd.toISOString().slice(0, 16);

        // Aplicar mÃ­nimo
        endInput.min = iso;

        // Si el end actual es invÃ¡lido â†’ ajustarlo
        if (endInput.value && endInput.value < iso) {
            endInput.value = iso;
        }
    }

    // Cuando cambia start_date â†’ actualizar min de end_date
    startInput.addEventListener("change", updateEndDateMin);

    // Ejecutar al cargar la pÃ¡gina (por si edita oferta existente)
    updateEndDateMin();
});
</script>

{% endwith %}
{% endwith %}

{% endblock %}

{% extends 'core/base.html' %}
{% load widget_tweaks %}

{% block title %}Editar Oferta â€“ {{ product.title }}{% endblock %}

{% block content %}

<div class="container mt-6">
    <div class="column is-half is-offset-one-quarter">
        <div class="box">

            <h1 class="title has-text-centered mb-5">
                ðŸ”¥ Oferta para <span class="has-text-info">{{ product.title }}</span>
            </h1>

            <!-- Info del producto -->
            <div class="notification is-light">
                <strong>Precio normal:</strong> ${{ product.price }} <br>

                {% if product.active_offer %}
                    <strong>Precio actual con oferta:</strong>
                    <span class="has-text-danger has-text-weight-bold">
                        ${{ product.final_price }}
                    </span>
                    <span class="tag is-success is-light ml-2">Oferta activa</span>
                {% else %}
                    <span class="tag is-light">Sin oferta activa</span>
                {% endif %}
            </div>


            <form method="post">
                {% csrf_token %}

                <!-- Campos del form -->
                {% for field in form %}
                <div class="field mt-4">
                    <label class="label">{{ field.label }}</label>

                    <div class="control">

                        {% if field.field.widget.input_type == "datetime-local" %}
                            {{ field|add_class:"input" }}

                        {% elif field.name == "is_2x1" %}
                            <label class="checkbox">{{ field }} 2x1</label>

                        {% elif field.name == "is_active" %}
                            <label class="checkbox">{{ field }} Activar oferta</label>

                        {% else %}
                            {{ field|add_class:"input" }}
                        {% endif %}

                    </div>

                    {% if field.errors %}
                        <p class="help is-danger">{{ field.errors }}</p>
                    {% endif %}
                </div>
                {% endfor %}

                <!-- Preview -->
                <div class="box mt-5 has-background-info-light">
                    <h2 class="subtitle mb-2">ðŸ’° Vista previa del precio final</h2>

                    <p><strong>Precio normal:</strong> ${{ product.price }}</p>

                    <p><strong>Precio final estimado:</strong>
                        <span id="preview-final" class="has-text-weight-bold">$â€”</span>
                    </p>
                </div>

                <!-- Botones -->
                <div class="field mt-6">
                    <button class="button is-primary is-medium is-fullwidth">
                        Guardar oferta
                    </button>
                </div>

                <a href="{% url 'vendor:vendor-admin' %}" class="button is-light is-fullwidth mt-2">
                    Volver
                </a>

            </form>

        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {

    const discountPercentage = document.getElementById("id_discount_percentage");
    const discountPrice = document.getElementById("id_discount_price");
    const is2x1 = document.getElementById("id_is_2x1");
    const preview = document.getElementById("preview-final");
    const startInput = document.getElementById("id_start_date");
    const endInput = document.getElementById("id_end_date");

    // ðŸ”¥ Precio base del producto
    const basePrice = parseInt('{{ product.price }}');

    /* ============================================
       1) FECHAS â€” PERMITIR HOY COMPLETO
       ============================================ */

    // ðŸ‘‰ Hoy a las 00:00, asÃ­ no bloqueamos el dÃ­a actual
    function todayMinDatetime() {
        const now = new Date();
        now.setHours(0, 0, 0, 0);    // dÃ­a actual completo permitido
        return now.toISOString().slice(0, 16);
    }

    const todayMin = todayMinDatetime();

    if (startInput) startInput.min = todayMin;
    if (endInput) endInput.min = todayMin;

    // Cuando se cambia start_date â†’ end_date debe ser mayor
    function updateEndDateMin() {
        if (!startInput || !endInput || !startInput.value) return;

        const d = new Date(startInput.value);
        const minEnd = new Date(d.getTime() + 60000);   // +1 minuto obligatorio
        endInput.min = minEnd.toISOString().slice(0, 16);
    }

    if (startInput) {
        startInput.addEventListener("change", updateEndDateMin);
        updateEndDateMin();
    }

    /* ============================================
       2) PREVIEW DINÃMICO
       ============================================ */
    function updatePreview() {
        if (!preview) return;

        let final = basePrice;

        if (discountPrice && discountPrice.value) {
            final = parseInt(discountPrice.value);
        } else if (discountPercentage && discountPercentage.value) {
            final = basePrice - Math.round(basePrice * (discountPercentage.value / 100));
        }

        preview.textContent = isNaN(final)
            ? "$â€”"
            : "$" + final.toLocaleString();
    }

    /* ============================================
       3) LÃ“GICA DEL 2x1
       ============================================ */
    function disableDiscounts() {
        if (discountPercentage) {
            discountPercentage.value = "";
            discountPercentage.disabled = true;
        }
        if (discountPrice) {
            discountPrice.value = "";
            discountPrice.disabled = true;
        }
    }

    function enableDiscounts() {
        if (discountPercentage) discountPercentage.disabled = false;
        if (discountPrice) discountPrice.disabled = false;
    }

    if (is2x1 && is2x1.checked) disableDiscounts();

    if (is2x1) {
        is2x1.addEventListener("change", () => {
            is2x1.checked ? disableDiscounts() : enableDiscounts();
            updatePreview();
        });
    }

    /* ============================================
       4) VALIDACIÃ“N DEL PORCENTAJE
       ============================================ */
    if (discountPercentage) {
        discountPercentage.setAttribute("maxlength", "2");

        discountPercentage.addEventListener("input", () => {
            const v = discountPercentage.value.replace(/\D/g, "").slice(0, 2);
            discountPercentage.value = v;

            discountPercentage.style.border =
                (v < 1 || v > 90) ? "2px solid red" : "";

            if (v) {
                if (is2x1) is2x1.checked = false;
                if (discountPrice) discountPrice.value = "";
            }

            updatePreview();
        });
    }

    /* ============================================
       5) VALIDACIÃ“N DEL PRECIO REBAJADO
       ============================================ */
    if (discountPrice) {
        discountPrice.setAttribute("maxlength", "6");

        discountPrice.addEventListener("input", () => {
            const v = discountPrice.value.replace(/\D/g, "").slice(0, 6);
            discountPrice.value = v;

            discountPrice.style.border =
                (!v || v < 1 || v >= basePrice) ? "2px solid red" : "";

            if (v) {
                if (is2x1) is2x1.checked = false;
                if (discountPercentage) discountPercentage.value = "";
            }

            updatePreview();
        });
    }

    /* ============================================
       6) BOTÃ“N CALCULAR PORCENTAJE AUTOMÃTICO
       ============================================ */
    if (discountPrice) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "Calcular % automÃ¡ticamente";
        btn.className = "button is-info is-fullwidth mt-2";

        discountPrice.parentNode.parentNode.appendChild(btn);

        btn.addEventListener("click", () => {
            const newPrice = parseInt(discountPrice.value);

            if (!newPrice || newPrice < 1 || newPrice >= basePrice) {
                alert("Ingresa un precio rebajado vÃ¡lido.");
                return;
            }

            let pct = Math.round(100 - (newPrice / basePrice * 100));
            pct = Math.max(1, Math.min(90, pct)); // rango permitido

            if (discountPercentage) discountPercentage.value = pct;
            if (is2x1) is2x1.checked = false;

            updatePreview();
        });
    }

    updatePreview();
});
</script>
{% endblock %}


{
  "version": "v2",
  "metadata": {
    "name": "ğŸ• PizzaBot (Local Mode)",
    "description": "Flujo completo de integraciÃ³n Django + ManyChat (modo local)."
  },
  "nodes": [
    {
      "id": "start",
      "type": "message",
      "text": "ğŸ‘‹ Â¡Hola {{first_name}}! Bienvenido a *PizzaBot*. ğŸ•\n\nAquÃ­ puedes elegir tus pizzas favoritas y pagar directamente en nuestra web.",
      "actions": [
        {
          "action": "request",
          "method": "POST",
          "url": "http://127.0.0.1:8000/api/cart/create/",
          "save_to": "cart_token",
          "on_success": {
            "action": "goto",
            "target": "menu"
          }
        }
      ]
    },
    {
      "id": "menu",
      "type": "message",
      "text": "Â¿QuÃ© te gustarÃ­a hacer?",
      "buttons": [
        {"text": "ğŸ• Ver pizzas", "action": "goto", "target": "ver_pizzas"},
        {"text": "ğŸ›’ Ver carrito", "action": "goto", "target": "ver_carrito"},
        {"text": "ğŸ’¬ Hablar con soporte", "action": "text", "value": "Te conectamos con soporte ğŸ‘¨â€ğŸ³"}
      ]
    },
    {
      "id": "ver_pizzas",
      "type": "request",
      "method": "GET",
      "url": "http://127.0.0.1:8000/api/products/",
      "save_to": "pizzas",
      "on_success": {
        "action": "gallery",
        "title_field": "title",
        "subtitle_field": "description",
        "image_field": "image",
        "items": "{{pizzas}}",
        "buttons": [
          {
            "text": "Agregar al carrito ğŸ•",
            "action": "request",
            "method": "POST",
            "url": "http://127.0.0.1:8000/api/cart/add/",
            "body": {
              "token": "{{cart_token}}",
              "product_id": "{{item.id}}",
              "quantity": 1
            },
            "on_success": {
              "action": "text",
              "value": "âœ… Agregaste {{item.title}} al carrito.\nÂ¿QuerÃ©s seguir eligiendo o ver tu carrito?",
              "buttons": [
                {"text": "ğŸ›’ Ver carrito", "action": "goto", "target": "ver_carrito"},
                {"text": "ğŸ• Ver mÃ¡s pizzas", "action": "goto", "target": "ver_pizzas"}
              ]
            }
          }
        ]
      }
    },
    {
      "id": "ver_carrito",
      "type": "request",
      "method": "GET",
      "url": "http://127.0.0.1:8000/api/cart/{{cart_token}}/",
      "save_to": "carrito",
      "on_success": {
        "action": "text",
        "value": "ğŸ§¾ Tu pedido:\n{{#each carrito.items}}\n- {{product}} Ã— {{quantity}}\n{{/each}}\n\nğŸ’° *Total:* {{carrito.total}} CLP",
        "buttons": [
          {
            "text": "ğŸ’³ Pagar ahora",
            "action": "open_url",
            "url": "http://127.0.0.1:8000/cart/checkout/start/?cart_token={{cart_token}}"
          },
          {"text": "ğŸ• Seguir eligiendo", "action": "goto", "target": "ver_pizzas"}
        ]
      }
    }
  ],
  "start_node": "start"
}
